<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bella Vista Restaurant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #F9FAFB;
            color: #1F2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        .header {
            background: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #EA580C;
        }

        .role-toggle {
            display: flex;
            background: #F3F4F6;
            border-radius: 12px;
            padding: 4px;
        }

        .role-toggle button {
            padding: 8px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .role-toggle button.active {
            background: #EA580C;
            color: white;
        }





        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #EA580C;
            color: white;
        }

        .btn-primary:hover {
            background: #DC2626;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #EF4444;
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-secondary {
            background: #6B7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4B5563;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1rem;
            color: #EA580C;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #EA580C;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }

        /* Cart Icon */
        .cart-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #EA580C;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(234, 88, 12, 0.3);
            z-index: 50;
        }

        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #EF4444;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* Menu Styles */
        .category-section {
            background: white;
            margin-bottom: 1.5rem;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .category-header {
            background: #F3F4F6;
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-header h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .category-items {
            padding: 1rem;
            display: none;
        }

        .category-items.expanded {
            display: block;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .admin-menu-scroll {
            display: flex;
            gap: 1rem;
            overflow-x: auto;
            padding: 1rem 0;
            scroll-behavior: smooth;
        }

        .admin-menu-scroll::-webkit-scrollbar {
            height: 8px;
        }

        .admin-menu-scroll::-webkit-scrollbar-track {
            background: #F3F4F6;
            border-radius: 4px;
        }

        .admin-menu-scroll::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 4px;
        }

        .admin-menu-scroll::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }

        .admin-menu-item {
            min-width: 280px;
            max-width: 280px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1rem;
            background: white;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .admin-menu-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .admin-menu-item h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .admin-menu-item p {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .menu-item {
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.2s;
        }

        .menu-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .menu-item h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .menu-item p {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .menu-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price {
            font-size: 1.2rem;
            font-weight: 700;
            color: #EA580C;
        }

        /* Admin Styles */
        .admin-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .admin-nav button {
            padding: 10px 20px;
            border: 1px solid #D1D5DB;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .admin-nav button.active {
            background: #EA580C;
            color: white;
            border-color: #EA580C;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .orders-grid {
            display: grid;
            gap: 1rem;
        }

        .order-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .order-number {
            font-weight: 700;
            color: #EA580C;
        }

        .order-items {
            margin: 1rem 0;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #F3F4F6;
        }

        .order-total {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: right;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #F3F4F6;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background: #FEF3C7;
            color: #92400E;
        }

        .status-accepted {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .status-completed {
            background: #D1FAE5;
            color: #065F46;
        }

        .status-rejected {
            background: #FEE2E2;
            color: #991B1B;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            .header {
                padding: 0.75rem 0;
            }

            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .logo {
                font-size: 1.25rem;
            }

            .role-toggle {
                width: 100%;
                max-width: 300px;
            }

            .role-toggle button {
                flex: 1;
                padding: 10px 12px;
            }

            .menu-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }

            .admin-nav {
                flex-direction: column;
                gap: 0.5rem;
            }

            .admin-nav button {
                padding: 12px 16px;
                text-align: center;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .cart-icon, #showOrdersBtn {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
                font-size: 1.2rem;
            }

            #showOrdersBtn {
                bottom: 75px;
            }

            .modal-content {
                margin: 10px;
                padding: 1.5rem;
                max-height: calc(100vh - 20px);
                width: calc(100% - 20px);
            }

            .category-header {
                padding: 0.75rem;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .category-header h3 {
                font-size: 1.1rem;
            }

            .category-header button {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .admin-menu-scroll {
                flex-direction: row;
                overflow-x: auto;
                overflow-y: visible;
                -webkit-overflow-scrolling: touch;
                scroll-snap-type: x mandatory;
            }

            .admin-menu-item {
                min-width: 280px;
                max-width: 280px;
                scroll-snap-align: start;
            }

            .menu-item-footer {
                flex-direction: column;
                gap: 0.75rem;
                align-items: stretch;
            }

            .admin-menu-item .menu-item-footer > div {
                display: flex;
                gap: 0.5rem;
            }

            .admin-menu-item .menu-item-footer button {
                flex: 1;
                font-size: 0.8rem;
                padding: 8px 6px;
            }

            .order-card {
                padding: 1rem;
            }

            .order-card > div:last-child {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .order-card > div:last-child button {
                width: 100%;
                padding: 10px;
                font-size: 0.9rem;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                padding: 12px;
                font-size: 16px; /* Prevents zoom on iOS */
            }

            .btn {
                padding: 12px 16px;
                font-size: 0.9rem;
                min-height: 44px; /* Better touch targets */
            }

            .order-item {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .order-item > div:last-child {
                align-self: flex-end;
                font-weight: 600;
            }

            .cart-badge {
                width: 20px;
                height: 20px;
                font-size: 11px;
                top: -3px;
                right: -3px;
            }

            .status-badge {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .price {
                font-size: 1.1rem;
            }

            .menu-item {
                padding: 0.75rem;
            }

            .menu-item h4 {
                font-size: 1rem;
            }

            .menu-item p {
                font-size: 0.85rem;
            }

            .category-items {
                padding: 0.75rem;
            }

            .empty-state {
                padding: 2rem 1rem;
                font-size: 0.9rem;
            }

            .loading {
                padding: 1.5rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 8px;
            }

            .logo {
                font-size: 1.1rem;
            }

            .modal-content {
                margin: 5px;
                padding: 1rem;
                width: calc(100% - 10px);
            }

            .modal-content h2 {
                font-size: 1.25rem;
                margin-bottom: 0.75rem;
            }

            .category-header {
                padding: 0.5rem;
            }

            .category-header h3 {
                font-size: 1rem;
            }

            .menu-item,
            .admin-menu-item,
            .order-card {
                padding: 0.5rem;
            }

            .cart-icon, #showOrdersBtn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            #showOrdersBtn {
                bottom: 70px;
            }

            .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
                min-height: 40px;
            }

            .form-group {
                margin-bottom: 0.75rem;
            }

            .admin-nav button {
                padding: 10px 12px;
                font-size: 0.85rem;
            }

            .order-total {
                font-size: 1rem;
            }

            .price {
                font-size: 1rem;
            }
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #6B7280;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6B7280;
        }

        .badge {
            background: #EF4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo" id="restaurantName" onclick="editRestaurantName()" style="cursor: pointer;" title="Click to edit restaurant name">Bella Vista Restaurant</div>
                <div id="role-toggle" class="role-toggle">
                    <button id="customerBtn" class="active">Customer</button>
                    <button id="adminBtn">Admin</button>
                </div>
                <button id="logoutBtn" class="btn btn-secondary hidden" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <!-- Customer Name Modal -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <h2>Welcome to Bella Vista!</h2>
            <p>Please enter your name to start ordering:</p>
            <div class="form-group">
                <input type="text" id="customerName" placeholder="Your name" required>
            </div>
            <button class="btn btn-primary" onclick="setCustomerName()">Start Ordering</button>
        </div>
    </div>

    <!-- Customer View -->
    <div id="customerView" class="container" style="padding-top: 2rem;">
        <!-- Customer Orders Modal -->
        <div id="customerOrdersModal" class="modal hidden">
            <div class="modal-content" style="max-width: 800px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2>Your Orders</h2>
                    <button class="btn btn-secondary" onclick="hideCustomerOrders()">✕ Close</button>
                </div>
                <div id="customerOrdersList"></div>
                <div id="customerOrdersTotal" class="order-total hidden"></div>
                <div style="margin-top: 1rem;">
                    <button id="requestBillBtn" class="btn btn-success hidden" onclick="requestBill()">Request Final Bill</button>

                </div>
            </div>
        </div>

        <div id="menuContainer">
            <div class="loading">Loading menu...</div>
        </div>
    </div>

    <!-- Admin View -->
    <div id="adminView" class="container hidden" style="padding-top: 2rem;">
        <div class="admin-nav">
            <button id="ordersTab" class="active" onclick="switchAdminTab('orders')">
                Orders <span id="ordersBadge" class="badge">0</span>
            </button>
            <button id="menuTab" onclick="switchAdminTab('menu')">Manage Menu</button>
        </div>

        <!-- Orders Management -->
        <div id="ordersContent" class="tab-content active">
            <div class="admin-nav">
                <button id="pendingTab" class="active" onclick="switchOrderTab('pending')">
                    Pending <span id="pendingBadge" class="badge">0</span>
                </button>
                <button id="acceptedTab" onclick="switchOrderTab('accepted')">
                    Accepted <span id="acceptedBadge" class="badge">0</span>
                </button>
                <button id="completedTab" onclick="switchOrderTab('completed')">
                    Completed <span id="completedBadge" class="badge">0</span>
                </button>
                <button id="rejectedTab" onclick="switchOrderTab('rejected')">
                    Rejected <span id="rejectedBadge" class="badge">0</span>
                </button>
            </div>

            <div id="pendingOrders" class="orders-grid"></div>
            <div id="acceptedOrders" class="orders-grid hidden"></div>
            <div id="completedOrders" class="orders-grid hidden"></div>
            <div id="rejectedOrders" class="orders-grid hidden"></div>
        </div>

        <!-- Menu Management -->
        <div id="menuContent" class="tab-content">
            <div style="margin-bottom: 2rem;">
                <button class="btn btn-primary" onclick="showAddItemModal()">Add New Item</button>
                <button class="btn btn-secondary" onclick="showAddCategoryModal()">Add Category</button>
            </div>
            <div id="adminMenuContainer"></div>
        </div>
    </div>

    <!-- Cart Icon -->
    <div id="cartIcon" class="cart-icon" onclick="showCart()">
        🛒
        <div id="cartBadge" class="cart-badge hidden">0</div>
    </div>

    <!-- Show Orders Button -->
    <div id="showOrdersBtn" class="cart-icon hidden" style="bottom: 90px; background: #10B981;" onclick="showCustomerOrders()">
        📋
        <div id="ordersBadgeCustomer" class="cart-badge hidden">0</div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Your Cart</h2>
            <div id="cartItems"></div>
            <div id="cartTotal" style="text-align: right; font-weight: bold; margin-top: 1rem;"></div>
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="hideCart()">Continue Shopping</button>
                <button class="btn btn-primary" onclick="proceedToCheckout()">Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Checkout</h2>
            <div id="checkoutItems"></div>
            <div class="form-group">
                <label>Order Type:</label>
                <select id="orderType" required>
                    <option value="dine-in">Dine In</option>
                    <option value="takeaway">Takeaway</option>
                </select>
            </div>
            <div class="form-group">
                <label>Special Instructions:</label>
                <textarea id="specialInstructions" rows="3" placeholder="Any special requests..."></textarea>
            </div>
            <div id="checkoutTotal" style="text-align: right; font-weight: bold; margin: 1rem 0;"></div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="hideCheckout()">Back to Cart</button>
                <button class="btn btn-success" onclick="placeOrder()">Place Order</button>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div id="addItemModal" class="modal hidden">
        <div class="modal-content">
            <h2>Add Menu Item</h2>
            <form id="addItemForm">
                <div class="form-group">
                    <label>Category:</label>
                    <select id="itemCategory" required></select>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="itemName" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="itemDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Price:</label>
                    <input type="number" id="itemPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="itemAvailable" checked> Available
                    </label>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideAddItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal hidden">
        <div class="modal-content">
            <h2>Add Category</h2>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label>Category Name:</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideAddCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div id="editItemModal" class="modal hidden">
        <div class="modal-content">
            <h2>Edit Menu Item</h2>
            <form id="editItemForm">
                <input type="hidden" id="editItemId">
                <div class="form-group">
                    <label>Category:</label>
                    <select id="editItemCategory" required></select>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" id="editItemName" required>
                </div>
                <div class="form-group">
                    <label>Description:</label>
                    <textarea id="editItemDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Price:</label>
                    <input type="number" id="editItemPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="editItemAvailable"> Available
                    </label>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideEditItemModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editCategoryModal" class="modal hidden">
        <div class="modal-content">
            <h2>Edit Category</h2>
            <form id="editCategoryForm">
                <input type="hidden" id="editCategoryId">
                <div class="form-group">
                    <label>Category Name:</label>
                    <input type="text" id="editCategoryName" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideEditCategoryModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div id="invoiceModal" class="modal hidden">
        <div class="modal-content" style="max-width: 700px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Invoice</h2>
                <button class="btn btn-secondary" onclick="hideInvoice()">✕ Close</button>
            </div>
            <div id="invoiceContent"></div>
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button id="approveInvoiceBtn" class="btn btn-success hidden" onclick="approveInvoice()">Approve & Send to Customer</button>
            </div>
        </div>
    </div>

    <!-- Thank You Modal -->
    <div id="thankYouModal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">🎉</div>
            <h2 style="color: #10B981; margin-bottom: 1rem;">Thank You!</h2>
            <p style="font-size: 1.1rem; margin-bottom: 1.5rem; color: #6B7280;">
                Your payment has been approved! Thank you for dining with us at <span id="thankYouRestaurantName">Bella Vista Restaurant</span>.
            </p>
            <p style="margin-bottom: 2rem; color: #6B7280;">
                We hope you enjoyed your meal and look forward to serving you again soon!
            </p>
            <button class="btn btn-primary" onclick="hideThankYou()">Close</button>
        </div>
    </div>

    <!-- Edit Restaurant Name Modal -->
    <div id="editNameModal" class="modal hidden">
        <div class="modal-content">
            <h2>Edit Restaurant Name</h2>
            <div class="form-group">
                <label>Restaurant Name:</label>
                <input type="text" id="newRestaurantName" required>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-secondary" onclick="hideEditNameModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveRestaurantName()">Save</button>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal hidden">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <form id="adminLoginForm">
                <div class="form-group">
                    <label>Email:</label>
                    <input type="email" id="adminEmail" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="adminPassword" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="hideAdminLoginModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Application State
        let currentRole = 'customer';
        let currentCustomer = '';
        let cart = [];
        let currentOrderTab = 'pending';
        let currentAdminTab = 'orders';


        // Supabase-backed functions will replace localStorage logic.
        // The old getData, saveData, and initializeDefaultData functions are no longer needed.

        // Role Management
        async function switchRole(role) {
            currentRole = role;
            document.getElementById('customerBtn').classList.toggle('active', role === 'customer');
            document.getElementById('adminBtn').classList.toggle('active', role === 'admin');
            document.getElementById('customerView').classList.toggle('hidden', role !== 'customer');
            document.getElementById('adminView').classList.toggle('hidden', role !== 'admin');
            document.getElementById('cartIcon').classList.toggle('hidden', role !== 'customer');
            document.getElementById('showOrdersBtn').classList.toggle('hidden', role !== 'customer');

            if (role === 'customer' && !currentCustomer) {
                document.getElementById('nameModal').classList.remove('hidden');
            } else if (role === 'admin') {
                await renderAdminView();
            }
        }

        // Customer Orders Management
        async function updateCustomerOrdersDisplay() {
            const showOrdersBtn = document.getElementById('showOrdersBtn');
            const ordersBadge = document.getElementById('ordersBadgeCustomer');

            if (!currentCustomer) {
                showOrdersBtn.classList.add('hidden');
                ordersBadge.classList.add('hidden');
                return;
            }

            const { data: myOrders, error } = await supabase
                .from('orders')
                .select('*')
                .eq('customer_name', currentCustomer);

            if (error) {
                console.error('Error fetching customer orders:', error);
                return;
            }

            const paymentConfirmed = myOrders.some(order => order.payment_confirmed);
            if (paymentConfirmed) {
                showThankYouMessage();
                showOrdersBtn.classList.add('hidden');
                ordersBadge.classList.add('hidden');
                return;
            }

            if (myOrders.length > 0) {
                showOrdersBtn.classList.remove('hidden');
                ordersBadge.textContent = myOrders.length;
                ordersBadge.classList.remove('hidden');
                
                const allCompleted = myOrders.every(order => order.status === 'completed');
                const requestBillBtn = document.getElementById('requestBillBtn');
                const hasPendingBill = myOrders.some(order => order.bill_requested && !order.bill_approved);
                const hasBillApproved = myOrders.some(order => order.bill_approved && !order.payment_confirmed);
                
                if (allCompleted && !hasPendingBill && !hasBillApproved) {
                    requestBillBtn.classList.remove('hidden');
                } else {
                    requestBillBtn.classList.add('hidden');
                }
            } else {
                showOrdersBtn.classList.add('hidden');
                ordersBadge.classList.add('hidden');
            }

            await renderCustomerOrders(myOrders);
        }

        async function renderCustomerOrders(myOrders) {
            const ordersList = document.getElementById('customerOrdersList');
            const ordersTotal = document.getElementById('customerOrdersTotal');

            if (!myOrders || myOrders.length === 0) {
                ordersList.innerHTML = '<div class="empty-state">No orders yet</div>';
                ordersTotal.classList.add('hidden');
                return;
            }

            // Fetch all order items for all orders in one go
            const orderIds = myOrders.map(o => o.id);
            const { data: allOrderItems, error } = await supabase
                .from('order_items')
                .select(`
                    *,
                    menu_items ( name )
                `)
                .in('order_id', orderIds);

            if (error) {
                console.error('Error fetching order items:', error);
                ordersList.innerHTML = '<div class="empty-state">Error loading order details.</div>';
                return;
            }

            ordersList.innerHTML = myOrders.map(order => {
                const itemsForThisOrder = allOrderItems.filter(item => item.order_id === order.id);
                return `
                    <div class="order-card" style="margin-bottom: 1rem;">
                        <div class="order-header">
                            <div>
                                <div class="order-number">Order #${order.id}</div>
                                <div>Type: ${order.order_type}</div>
                                <div>Time: ${new Date(order.timestamp).toLocaleString()}</div>
                            </div>
                            <div class="status-badge status-${order.status}">${order.status.toUpperCase()}</div>
                        </div>

                        <div class="order-items">
                            ${itemsForThisOrder.map(item => `
                                <div class="order-item">
                                    <div>${item.menu_items.name} x ${item.quantity}</div>
                                    <div>$${(item.price * item.quantity).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>

                        ${order.special_instructions ? `<div style="margin-top: 0.5rem;"><strong>Special Instructions:</strong> ${order.special_instructions}</div>` : ''}

                        <div class="order-total">Total: $${order.total.toFixed(2)}</div>

                        ${order.bill_requested && !order.bill_approved ? '<div style="background: #FEF3C7; color: #92400E; padding: 0.5rem; border-radius: 8px; margin-top: 1rem; text-align: center;">Bill Requested - Waiting for approval</div>' : ''}
                        ${order.bill_approved && !order.payment_confirmed ? '<div style="background: #DBEAFE; color: #1E40AF; padding: 0.5rem; border-radius: 8px; margin-top: 1rem; text-align: center;">Bill Approved - Please confirm payment</div>' : ''}
                        ${order.payment_confirmed ? '<div style="background: #D1FAE5; color: #065F46; padding: 0.5rem; border-radius: 8px; margin-top: 1rem; text-align: center;">Payment Confirmed - Thank you!</div>' : ''}
                    </div>
                `;
            }).join('');

            const totalAmount = myOrders.reduce((sum, order) => sum + parseFloat(order.total), 0);
            ordersTotal.innerHTML = `<strong>Total Amount: $${totalAmount.toFixed(2)}</strong>`;
            ordersTotal.classList.remove('hidden');
        }

        function showCustomerOrders() {
            document.getElementById('customerOrdersModal').classList.remove('hidden');
            updateCustomerOrdersDisplay();
        }

        function hideCustomerOrders() {
            document.getElementById('customerOrdersModal').classList.add('hidden');
        }

        async function requestBill() {
            const { error } = await supabase
                .from('orders')
                .update({ bill_requested: true })
                .eq('customer_name', currentCustomer)
                .eq('status', 'completed');

            if (error) {
                console.error('Error requesting bill:', error);
                alert('Failed to request bill.');
                return;
            }

            await updateCustomerOrdersDisplay();
            alert('Bill requested! Please wait for admin approval.');
        }



        function showThankYouMessage() {
            // Hide customer orders modal if open
            hideCustomerOrders();
            // Show thank you modal
            document.getElementById('thankYouModal').classList.remove('hidden');
        }

        function hideThankYou() {
            document.getElementById('thankYouModal').classList.add('hidden');
        }

        // Customer Name Management
        async function setCustomerName() {
            const name = document.getElementById('customerName').value.trim();
            if (name) {
                currentCustomer = name;
                document.getElementById('nameModal').classList.add('hidden');
                await renderMenu();
                await updateCustomerOrdersDisplay();
            } else {
                alert('Please enter your name');
            }
        }

        // Menu Rendering
        async function renderMenu() {
            const container = document.getElementById('menuContainer');
            container.innerHTML = '<div class="loading">Loading menu...</div>';

            const { data: categories, error: categoriesError } = await supabase
                .from('categories')
                .select('*')
                .order('id', { ascending: true });

            if (categoriesError) {
                console.error('Error fetching categories:', categoriesError);
                container.innerHTML = '<div class="empty-state">Error loading menu. Please try again later.</div>';
                return;
            }

            const { data: menuItems, error: menuItemsError } = await supabase
                .from('menu_items')
                .select('*');

            if (menuItemsError) {
                console.error('Error fetching menu items:', menuItemsError);
                container.innerHTML = '<div class="empty-state">Error loading menu items. Please try again later.</div>';
                return;
            }

            if (categories.length === 0) {
                container.innerHTML = '<div class="empty-state">No menu items available</div>';
                return;
            }

            container.innerHTML = categories.map(category => {
                const categoryItems = menuItems.filter(item => item.category_id === category.id && item.available);
                
                return `
                    <div class="category-section">
                        <div class="category-header" onclick="toggleCategory(${category.id})">
                            <h3>${category.name}</h3>
                            <span id="arrow-${category.id}">▼</span>
                        </div>
                        <div id="category-${category.id}" class="category-items">
                            <div class="menu-grid">
                                ${categoryItems.map(item => `
                                    <div class="menu-item">
                                        <h4>${item.name}</h4>
                                        <p>${item.description}</p>
                                        <div class="menu-item-footer">
                                            <span class="price">$${item.price.toFixed(2)}</span>
                                            <button class="btn btn-primary" onclick='addToCart(${JSON.stringify(item)})' ${!item.available ? 'disabled' : ''}>
                                                ${item.available ? 'Add to Cart' : 'Out of Stock'}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Expand first category by default
            if (categories.length > 0) {
                toggleCategory(categories[0].id);
            }
        }

        function toggleCategory(categoryId) {
            const categoryItems = document.getElementById(`category-${categoryId}`);
            const arrow = document.getElementById(`arrow-${categoryId}`);
            
            categoryItems.classList.toggle('expanded');
            arrow.textContent = categoryItems.classList.contains('expanded') ? '▲' : '▼';
        }

        function toggleAdminCategory(categoryId) {
            const categoryItems = document.getElementById(`admin-category-${categoryId}`);
            const arrow = document.getElementById(`admin-arrow-${categoryId}`);
            
            categoryItems.classList.toggle('expanded');
            arrow.textContent = categoryItems.classList.contains('expanded') ? '▲' : '▼';
        }

        // Cart Management
        function addToCart(item) {
            if (!item) return;

            const existingItem = cart.find(i => i.id === item.id);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...item, quantity: 1 });
            }

            updateCartDisplay();
        }

        function removeFromCart(itemId) {
            cart = cart.filter(item => item.id !== itemId);
            updateCartDisplay();
        }

        function updateCartQuantity(itemId, quantity) {
            const item = cart.find(i => i.id === itemId);
            if (item) {
                if (quantity <= 0) {
                    removeFromCart(itemId);
                } else {
                    item.quantity = quantity;
                }
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartBadge = document.getElementById('cartBadge');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            
            if (totalItems > 0) {
                cartBadge.textContent = totalItems;
                cartBadge.classList.remove('hidden');
            } else {
                cartBadge.classList.add('hidden');
            }

            // If cart modal is open, refresh its content
            const cartModal = document.getElementById('cartModal');
            if (!cartModal.classList.contains('hidden')) {
                refreshCartModal();
            }
        }

        function refreshCartModal() {
            if (cart.length === 0) {
                hideCart();
                return;
            }

            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            cartItems.innerHTML = cart.map(item => `
                <div class="order-item">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>$${item.price.toFixed(2)} each</small>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn btn-secondary" style="padding: 5px 10px; min-width: 30px;" onclick="updateCartQuantity(${item.id}, ${item.quantity - 1})">-</button>
                        <span style="min-width: 30px; text-align: center; display: inline-block;">${item.quantity}</span>
                        <button class="btn btn-secondary" style="padding: 5px 10px; min-width: 30px;" onclick="updateCartQuantity(${item.id}, ${item.quantity + 1})">+</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="removeFromCart(${item.id})">✕</button>
                    </div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = `Total: $${total.toFixed(2)}`;
        }

        function showCart() {
            if (cart.length === 0) {
                alert('Your cart is empty');
                return;
            }

            refreshCartModal();
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function hideCart() {
            document.getElementById('cartModal').classList.add('hidden');
        }

        function proceedToCheckout() {
            hideCart();
            
            const checkoutItems = document.getElementById('checkoutItems');
            const checkoutTotal = document.getElementById('checkoutTotal');
            
            checkoutItems.innerHTML = cart.map(item => `
                <div class="order-item">
                    <div>
                        <strong>${item.name}</strong> x ${item.quantity}<br>
                        <small>$${item.price.toFixed(2)} each</small>
                    </div>
                    <div>$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            checkoutTotal.textContent = `Total: $${total.toFixed(2)}`;

            document.getElementById('checkoutModal').classList.remove('hidden');
        }

        function hideCheckout() {
            document.getElementById('checkoutModal').classList.add('hidden');
            showCart();
        }

        async function placeOrder() {
            if (cart.length === 0) return;

            const orderDetails = {
                customer_name_in: currentCustomer,
                order_type_in: document.getElementById('orderType').value,
                special_instructions_in: document.getElementById('specialInstructions').value,
                total_in: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                items_in: cart.map(item => ({
                    id: item.id,
                    quantity: item.quantity,
                    price: item.price
                }))
            };

            const { data: newOrderId, error } = await supabase.rpc('create_order_with_items', orderDetails);

            if (error) {
                console.error('Error placing order:', error);
                alert('There was an error placing your order. Please try again.');
                return;
            }

            // Clear cart
            cart = [];
            updateCartDisplay();
            
            // Hide checkout modal
            document.getElementById('checkoutModal').classList.add('hidden');
            
            // Clear form
            document.getElementById('orderType').value = 'dine-in';
            document.getElementById('specialInstructions').value = '';
            
            alert(`Order placed successfully! Order #${newOrderId}`);
            
            await updateCustomerOrdersDisplay();
        }

        // Admin Functions
        async function switchAdminTab(tab) {
            currentAdminTab = tab;
            document.getElementById('ordersTab').classList.toggle('active', tab === 'orders');
            document.getElementById('menuTab').classList.toggle('active', tab === 'menu');
            document.getElementById('ordersContent').classList.toggle('active', tab === 'orders');
            document.getElementById('menuContent').classList.toggle('active', tab === 'menu');

            if (tab === 'orders') {
                renderOrders();
            } else if (tab === 'menu') {
                await renderAdminMenu();
            }
        }

        function switchOrderTab(status) {
            currentOrderTab = status;
            
            // Update tab buttons
            ['pending', 'accepted', 'completed', 'rejected'].forEach(s => {
                document.getElementById(`${s}Tab`).classList.toggle('active', s === status);
                document.getElementById(`${s}Orders`).classList.toggle('hidden', s !== status);
            });

            renderOrders();
        }

        async function renderAdminView() {
            await renderOrders();
            await updateOrderBadges();
        }

        async function renderOrders() {
            const container = document.getElementById(`${currentOrderTab}Orders`);
            container.innerHTML = '<div class="loading">Loading orders...</div>';

            const { data: orders, error } = await supabase
                .from('orders')
                .select(`
                    *,
                    order_items (
                        *,
                        menu_items ( name )
                    )
                `)
                .eq('status', currentOrderTab)
                .order('timestamp', { ascending: false });

            if (error) {
                console.error(`Error fetching ${currentOrderTab} orders:`, error);
                container.innerHTML = '<div class="empty-state">Failed to load orders.</div>';
                return;
            }

            if (orders.length === 0) {
                container.innerHTML = '<div class="empty-state">No orders found</div>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-number">Order #${order.id}</div>
                            <div>Customer: ${order.customer_name}</div>
                            <div>Type: ${order.order_type}</div>
                            <div>Time: ${new Date(order.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="status-badge status-${order.status}">${order.status.toUpperCase()}</div>
                    </div>
                    
                    <div class="order-items">
                        ${order.order_items.map(item => `
                            <div class="order-item">
                                <div>${item.menu_items.name} x ${item.quantity}</div>
                                <div>$${(item.price * item.quantity).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>

                    ${order.special_instructions ? `<div><strong>Special Instructions:</strong> ${order.special_instructions}</div>` : ''}
                    
                    <div class="order-total">Total: $${order.total.toFixed(2)}</div>
                    
                    ${order.bill_requested ? '<div style="background: #FEF3C7; color: #92400E; padding: 0.5rem; border-radius: 8px; margin: 1rem 0; text-align: center; font-weight: bold;">🧾 BILL REQUESTED</div>' : ''}
                    
                    <div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        ${order.status === 'pending' ? `
                            <button class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'accepted')">Accept</button>
                            <button class="btn btn-danger" onclick="updateOrderStatus(${order.id}, 'rejected')">Reject</button>
                        ` : ''}
                        ${order.status === 'accepted' ? `
                            <button type="button" class="btn btn-primary" onclick="updateOrderStatus(${order.id}, 'completed')">Mark Complete</button>
                        ` : ''}
                        ${order.status === 'rejected' ? `
                            <button type="button" class="btn btn-success" onclick="updateOrderStatus(${order.id}, 'pending')">Restore to Pending</button>
                        ` : ''}
                        ${order.bill_requested && !order.bill_approved ? `
                            <button type="button" class="btn btn-primary" onclick="generateInvoice('${order.customer_name}')">Generate Invoice</button>
                        ` : ''}
                        ${order.bill_approved && !order.payment_confirmed ? `
                            <button type="button" class="btn btn-success" onclick="confirmPayment('${order.customer_name}')">Confirm Payment Received</button>
                        ` : ''}
                        ${(order.status === 'completed' || order.status === 'rejected') ? `
                            <button type="button" class="btn btn-danger" onclick="deleteOrder(${order.id})">Delete</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            updateOrderBadges(); // This will also need to be refactored.
        }

        // Invoice Management
        async function generateInvoice(customerName) {
            const { data: customerOrders, error } = await supabase
                .from('orders')
                .select('*, order_items(*, menu_items(name))')
                .eq('customer_name', customerName)
                .eq('bill_requested', true)
                .eq('payment_confirmed', false);

            if (error || !customerOrders || customerOrders.length === 0) {
                console.error('Error fetching orders for invoice:', error);
                alert('No orders found for bill generation');
                return;
            }

            const invoiceContent = document.getElementById('invoiceContent');
            const totalAmount = customerOrders.reduce((sum, order) => sum + parseFloat(order.total), 0);
            const tax = totalAmount * 0.1; // 10% tax
            const grandTotal = totalAmount + tax;

            invoiceContent.innerHTML = `
                <div style="border: 1px solid #E5E7EB; border-radius: 8px; padding: 1.5rem; background: #F9FAFB;">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <h3 style="color: #EA580C; margin-bottom: 0.5rem;">Bella Vista Restaurant</h3>
                        <p style="margin: 0; color: #6B7280;">Final Bill Invoice</p>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <strong>Customer:</strong> ${customerName}<br>
                        <strong>Date:</strong> ${new Date().toLocaleDateString()}<br>
                        <strong>Time:</strong> ${new Date().toLocaleTimeString()}
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: #1F2937;">Order Details:</h4>
                        ${customerOrders.map(order => `
                            <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 8px;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">Order #${order.id} - ${order.order_type}</div>
                                <div style="font-size: 0.9rem; color: #6B7280; margin-bottom: 0.5rem;">${new Date(order.timestamp).toLocaleString()}</div>
                                ${order.order_items.map(item => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                                        <span>${item.menu_items.name} x ${item.quantity}</span>
                                        <span>$${(item.price * item.quantity).toFixed(2)}</span>
                                    </div>
                                `).join('')}
                                ${order.special_instructions ? `<div style="font-size: 0.9rem; color: #6B7280; margin-top: 0.5rem;"><em>Note: ${order.special_instructions}</em></div>` : ''}
                                <div style="text-align: right; font-weight: 600; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #E5E7EB;">
                                    Order Total: $${order.total.toFixed(2)}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div style="border-top: 2px solid #E5E7EB; padding-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Subtotal:</span>
                            <span>$${totalAmount.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span>Tax (10%):</span>
                            <span>$${tax.toFixed(2)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: bold; color: #EA580C;">
                            <span>Grand Total:</span>
                            <span>$${grandTotal.toFixed(2)}</span>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #E5E7EB; color: #6B7280; font-size: 0.9rem;">
                        Thank you for dining with us!
                    </div>
                </div>
            `;

            document.getElementById('approveInvoiceBtn').classList.remove('hidden');
            document.getElementById('approveInvoiceBtn').setAttribute('data-customer', customerName);
            document.getElementById('invoiceModal').classList.remove('hidden');
        }

        function hideInvoice() {
            document.getElementById('invoiceModal').classList.add('hidden');
            document.getElementById('approveInvoiceBtn').classList.add('hidden');
        }

        async function approveInvoice() {
            const customerName = document.getElementById('approveInvoiceBtn').getAttribute('data-customer');
            
            const { error } = await supabase
                .from('orders')
                .update({ bill_approved: true })
                .eq('customer_name', customerName)
                .eq('bill_requested', true);

            if (error) {
                console.error('Error approving invoice:', error);
                alert('Failed to approve invoice.');
                return;
            }

            hideInvoice();
            // No manual render needed, real-time will update the view.
            alert(`Invoice approved and sent to ${customerName}! Waiting for payment.`);
        }

        async function confirmPayment(customerName) {
            const { error } = await supabase
                .from('orders')
                .update({ payment_confirmed: true })
                .eq('customer_name', customerName)
                .eq('bill_approved', true);

            if (error) {
                console.error('Error confirming payment:', error);
                alert('Failed to confirm payment.');
                return;
            }

            // No manual render needed, real-time will update the view.
            alert(`Payment confirmed for ${customerName}!`);
        }

        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) {
                console.error('Error updating order status:', error);
                alert('Failed to update order status.');
                // No return here, so the UI still updates on the client.
            }
            // No manual render needed, real-time will update the view.
        }

        async function deleteOrder(orderId) {
            if (confirm('Are you sure you want to delete this order?')) {
                const { error } = await supabase
                    .from('orders')
                    .delete()
                    .eq('id', orderId);

                if (error) {
                    console.error('Error deleting order:', error);
                    alert('Failed to delete order.');
                }
                // No manual render needed, real-time will update the view.
            }
        }

        async function updateOrderBadges() {
            const { data: orders, error } = await supabase
                .from('orders')
                .select('id, status');

            if (error) {
                console.error('Error fetching orders for badges:', error);
                return;
            }

            const statusCounts = {
                pending: orders.filter(o => o.status === 'pending').length,
                accepted: orders.filter(o => o.status === 'accepted').length,
                completed: orders.filter(o => o.status === 'completed').length,
                rejected: orders.filter(o => o.status === 'rejected').length
            };

            Object.keys(statusCounts).forEach(status => {
                const badge = document.getElementById(`${status}Badge`);
                badge.textContent = statusCounts[status];
                badge.classList.toggle('hidden', statusCounts[status] === 0);
            });

            const totalOrders = orders.length;
            const ordersBadge = document.getElementById('ordersBadge');
            ordersBadge.textContent = totalOrders;
            ordersBadge.classList.toggle('hidden', totalOrders === 0);
        }

        // Menu Management
        async function renderAdminMenu() {
            const container = document.getElementById('adminMenuContainer');
            container.innerHTML = '<div class="loading">Loading menu...</div>';

            const { data: categories, error: categoriesError } = await supabase
                .from('categories')
                .select('*')
                .order('id', { ascending: true });

            if (categoriesError) {
                console.error('Error fetching categories:', categoriesError);
                container.innerHTML = '<div class="empty-state">Error loading menu.</div>';
                return;
            }

            const { data: menuItems, error: menuItemsError } = await supabase
                .from('menu_items')
                .select('*')
                .order('id', { ascending: true });

            if (menuItemsError) {
                console.error('Error fetching menu items:', menuItemsError);
                container.innerHTML = '<div class="empty-state">Error loading menu items.</div>';
                return;
            }

            container.innerHTML = categories.map(category => {
                const categoryItems = menuItems.filter(item => item.category_id === category.id);
                
                return `
                    <div class="category-section">
                        <div class="category-header" onclick="toggleAdminCategory(${category.id})">
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <h3 onclick="event.stopPropagation(); editCategoryName(${category.id})" style="cursor: pointer; color: #EA580C;" title="Click to edit category name">${category.name}</h3>
                                <span id="admin-arrow-${category.id}">▼</span>
                            </div>
                            <button type="button" class="btn btn-danger" onclick="event.stopPropagation(); deleteCategory(${category.id})">Delete Category</button>
                        </div>
                        <div id="admin-category-${category.id}" class="category-items">
                            <div class="admin-menu-scroll">
                                ${categoryItems.map(item => `
                                    <div class="admin-menu-item">
                                        <h4>${item.name} ${!item.available ? '(Out of Stock)' : ''}</h4>
                                        <p>${item.description}</p>
                                        <div class="menu-item-footer">
                                            <span class="price">$${item.price.toFixed(2)}</span>
                                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                                <button type="button" class="btn btn-primary" onclick="editMenuItem(${item.id})" style="font-size: 0.8rem; padding: 5px 10px;">Edit</button>
                                                <button type="button" class="btn btn-secondary" onclick="toggleItemAvailability(${item.id}, ${item.available})" style="font-size: 0.8rem; padding: 5px 10px;">
                                                    ${item.available ? 'Unavailable' : 'Available'}
                                                </button>
                                                <button type="button" class="btn btn-danger" onclick="deleteMenuItem(${item.id})" style="font-size: 0.8rem; padding: 5px 10px;">Delete</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Expand first category by default
            if (categories.length > 0) {
                toggleAdminCategory(categories[0].id);
            }
        }

        async function showAddItemModal() {
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option>Loading categories...</option>';
            
            const { data: categories, error } = await supabase
                .from('categories')
                .select('id, name')
                .order('name', { ascending: true });

            if (error) {
                console.error('Error fetching categories for modal:', error);
                categorySelect.innerHTML = '<option>Error loading categories</option>';
                return;
            }

            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat.id}">${cat.name}</option>`
            ).join('');
            
            document.getElementById('addItemModal').classList.remove('hidden');
        }

        function hideAddItemModal() {
            document.getElementById('addItemModal').classList.add('hidden');
            document.getElementById('addItemForm').reset();
        }

        function showAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.remove('hidden');
        }

        function hideAddCategoryModal() {
            document.getElementById('addCategoryModal').classList.add('hidden');
            document.getElementById('addCategoryForm').reset();
        }

        async function toggleItemAvailability(itemId, isAvailable) {
            const { error } = await supabase
                .from('menu_items')
                .update({ available: !isAvailable })
                .eq('id', itemId);

            if (error) {
                console.error('Error toggling item availability:', error);
                alert('Failed to update item availability.');
                return;
            }

            await renderAdminMenu();
            if (currentRole === 'customer') {
                await renderMenu();
            }
        }

        async function deleteMenuItem(itemId) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                const { error } = await supabase
                    .from('menu_items')
                    .delete()
                    .eq('id', itemId);

                if (error) {
                    console.error('Error deleting menu item:', error);
                    alert('Failed to delete menu item.');
                    return;
                }

                await renderAdminMenu();
                if (currentRole === 'customer') {
                    await renderMenu();
                }
            }
        }

        async function deleteCategory(categoryId) {
            // No need to check for items, the database handles cascade delete.
            // However, a confirmation is still good practice.
            if (confirm('Are you sure you want to delete this category? This will also delete all menu items within it.')) {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', categoryId);

                if (error) {
                    console.error('Error deleting category:', error);
                    alert('Failed to delete category.');
                    return;
                }

                await renderAdminMenu();
                if (currentRole === 'customer') {
                    await renderMenu();
                }
            }
        }

        async function editMenuItem(itemId) {
            const { data: item, error: itemError } = await supabase
                .from('menu_items')
                .select('*')
                .eq('id', itemId)
                .single();

            if (itemError) {
                console.error('Error fetching item for edit:', itemError);
                alert('Could not load item details.');
                return;
            }

            const { data: categories, error: catError } = await supabase
                .from('categories')
                .select('id, name');

            if (catError) {
                console.error('Error fetching categories for edit:', catError);
                alert('Could not load categories.');
                return;
            }

            // Populate category dropdown
            const categorySelect = document.getElementById('editItemCategory');
            categorySelect.innerHTML = categories.map(cat => 
                `<option value="${cat.id}" ${cat.id === item.category_id ? 'selected' : ''}>${cat.name}</option>`
            ).join('');

            // Populate form fields
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemDescription').value = item.description;
            document.getElementById('editItemPrice').value = item.price;
            document.getElementById('editItemAvailable').checked = item.available;

            document.getElementById('editItemModal').classList.remove('hidden');
        }

        function hideEditItemModal() {
            document.getElementById('editItemModal').classList.add('hidden');
            document.getElementById('editItemForm').reset();
        }

        async function editCategoryName(categoryId) {
            const { data: category, error } = await supabase
                .from('categories')
                .select('id, name')
                .eq('id', categoryId)
                .single();
            
            if (error) {
                console.error('Error fetching category for edit:', error);
                alert('Could not load category details.');
                return;
            }

            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryModal').classList.remove('hidden');
        }

        function hideEditCategoryModal() {
            document.getElementById('editCategoryModal').classList.add('hidden');
            document.getElementById('editCategoryForm').reset();
        }

        // Modal click-outside-to-close functionality
        function setupModalCloseOnOutsideClick() {
            const modals = ['cartModal', 'checkoutModal', 'customerOrdersModal', 'invoiceModal', 'addItemModal', 'addCategoryModal', 'thankYouModal', 'editNameModal', 'editItemModal', 'editCategoryModal'];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            modal.classList.add('hidden');
                        }
                    });
                }
            });
        }

        // Event Listeners
        document.getElementById('customerBtn').addEventListener('click', () => switchRole('customer'));
        document.getElementById('adminBtn').addEventListener('click', () => showAdminLoginModal());

        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const newItem = {
                category_id: parseInt(document.getElementById('itemCategory').value),
                name: document.getElementById('itemName').value.trim(),
                description: document.getElementById('itemDescription').value.trim(),
                price: parseFloat(document.getElementById('itemPrice').value),
                available: document.getElementById('itemAvailable').checked
            };

            if (!newItem.name || !newItem.price) {
                alert('Please provide at least a name and a price.');
                return;
            }

            const { error } = await supabase
                .from('menu_items')
                .insert([newItem]);

            if (error) {
                console.error('Error adding menu item:', error);
                alert('Failed to add menu item.');
                return;
            }
            
            hideAddItemModal();
            await renderAdminMenu();
            if (currentRole === 'customer') {
                await renderMenu();
            }
        });

        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });

            if (error) {
                alert('Login failed: ' + error.message);
            } else {
                // UI changes are handled by onAuthStateChange
                hideAdminLoginModal();
            }
        });

        async function logout() {
            await supabase.auth.signOut();
            // UI changes are handled by onAuthStateChange
        }

        document.getElementById('addCategoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categoryName = document.getElementById('categoryName').value.trim();
            if (!categoryName) {
                alert('Please enter a category name.');
                return;
            }

            const { error } = await supabase
                .from('categories')
                .insert([{ name: categoryName }]);

            if (error) {
                console.error('Error adding category:', error);
                alert('Failed to add category.');
                return;
            }
            
            hideAddCategoryModal();
            // Re-render menus to show the new category
            await renderAdminMenu();
            if (currentRole === 'customer') {
                await renderMenu();
            }
        });

        document.getElementById('editItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const itemId = parseInt(document.getElementById('editItemId').value);
            const updatedItem = {
                category_id: parseInt(document.getElementById('editItemCategory').value),
                name: document.getElementById('editItemName').value.trim(),
                description: document.getElementById('editItemDescription').value.trim(),
                price: parseFloat(document.getElementById('editItemPrice').value),
                available: document.getElementById('editItemAvailable').checked
            };

            const { error } = await supabase
                .from('menu_items')
                .update(updatedItem)
                .eq('id', itemId);

            if (error) {
                console.error('Error updating menu item:', error);
                alert('Failed to update menu item.');
                return;
            }
            
            hideEditItemModal();
            await renderAdminMenu();
            if (currentRole === 'customer') {
                await renderMenu();
            }
        });

        document.getElementById('editCategoryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const categoryId = parseInt(document.getElementById('editCategoryId').value);
            const newName = document.getElementById('editCategoryName').value.trim();

            if (!newName) {
                alert('Category name cannot be empty.');
                return;
            }

            const { error } = await supabase
                .from('categories')
                .update({ name: newName })
                .eq('id', categoryId);

            if (error) {
                console.error('Error updating category:', error);
                alert('Failed to update category.');
                return;
            }
            
            hideEditCategoryModal();
            await renderAdminMenu();
            if (currentRole === 'customer') {
                await renderMenu();
            }
        });

        // Restaurant Name Management
        async function editRestaurantName() {
            if (currentRole !== 'admin') {
                alert('Only admin can edit restaurant name');
                return;
            }
            
            const { data, error } = await supabase
                .from('restaurant')
                .select('name')
                .eq('id', 1)
                .single();

            const currentName = error ? 'Bella Vista Restaurant' : data.name;
            document.getElementById('newRestaurantName').value = currentName;
            document.getElementById('editNameModal').classList.remove('hidden');
        }

        function hideEditNameModal() {
            document.getElementById('editNameModal').classList.add('hidden');
        }

        function showAdminLoginModal() {
            document.getElementById('adminLoginModal').classList.remove('hidden');
        }

        function hideAdminLoginModal() {
            document.getElementById('adminLoginModal').classList.add('hidden');
            const form = document.getElementById('adminLoginForm');
            if(form) form.reset();
        }

        async function saveRestaurantName() {
            const newName = document.getElementById('newRestaurantName').value.trim();
            if (!newName) {
                alert('Please enter a restaurant name');
                return;
            }
            
            const { error } = await supabase
                .from('restaurant')
                .update({ name: newName })
                .eq('id', 1);

            if (error) {
                console.error('Error updating restaurant name:', error);
                alert('Failed to update restaurant name.');
                return;
            }

            await updateRestaurantNameDisplay();
            hideEditNameModal();
            alert('Restaurant name updated successfully!');
        }

        async function updateRestaurantNameDisplay() {
            const { data, error } = await supabase
                .from('restaurant')
                .select('name')
                .eq('id', 1)
                .single();

            const restaurantName = error ? 'Bella Vista Restaurant' : data.name;
            document.getElementById('restaurantName').textContent = restaurantName;
            document.getElementById('thankYouRestaurantName').textContent = restaurantName;
        }



        // Real-time Subscription
        function subscribeToOrderChanges() {
            supabase.channel('custom-all-channel')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'orders' },
                    (payload) => {
                        console.log('Order change detected:', payload);

                        // If admin is active, refresh their view
                        if (currentRole === 'admin') {
                            renderOrders();
                            updateOrderBadges();
                        }

                        // If a customer is active, check if the change affects them
                        const changedOrder = payload.new || payload.old;
                        if (currentRole === 'customer' && changedOrder && changedOrder.customer_name === currentCustomer) {
                            updateCustomerOrdersDisplay();
                        }
                    }
                )
                .subscribe();
        }

        // Initialize Application
        async function init() {
            // The initializeDefaultData function has been removed.
            await updateOrderBadges();
            setupModalCloseOnOutsideClick();
            await updateRestaurantNameDisplay();
            
            subscribeToOrderChanges();

            supabase.auth.onAuthStateChange((_event, session) => {
                const user = session?.user;
                if (user) {
                    // User is logged in
                    document.getElementById('role-toggle').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    // If not already in admin view, switch to it
                    if (currentRole !== 'admin') {
                        currentRole = 'admin';
                        document.getElementById('customerBtn').classList.remove('active');
                        document.getElementById('adminBtn').classList.add('active');
                        document.getElementById('customerView').classList.add('hidden');
                        document.getElementById('adminView').classList.remove('hidden');
                        document.getElementById('cartIcon').classList.add('hidden');
                        document.getElementById('showOrdersBtn').classList.add('hidden');
                        renderAdminView();
                    }
                } else {
                    // User is logged out
                    document.getElementById('role-toggle').classList.remove('hidden');
                    document.getElementById('logoutBtn').classList.add('hidden');
                    // If we were in the admin view, switch back to customer
                    if (currentRole === 'admin') {
                        switchRole('customer');
                    }
                }
            });

            // Initial check for customer view
            const { data: { session } } = await supabase.auth.getSession();
            if (!session?.user) {
                 if (!currentCustomer) {
                    document.getElementById('nameModal').classList.remove('hidden');
                } else {
                    await renderMenu();
                    await updateCustomerOrdersDisplay();
                }
            }
        }

        // Start the application
        init();
    </script>
</body>
</html>
